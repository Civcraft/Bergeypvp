package vg.civcraft.mc.besterarmor;

import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitScheduler;

import vg.civcraft.mc.besterarmor.ArmorData.ArmorType;
import vg.civcraft.mc.besterarmor.Listeners.ArmorListener;
import vg.civcraft.mc.besterarmor.Listeners.DecloakListener;
import vg.civcraft.mc.besterarmor.Listeners.HorseMountListener;
import vg.civcraft.mc.besterarmor.Managers.ArmorManager;

public class BesterArmor extends JavaPlugin
{
	private static BesterArmor thisPlugin;
	
	private static ArmorManager armorManager;
	
	private static ArmorListener armorListener;
	private static HorseMountListener horseListener;
	private static DecloakListener decloakListener;
	
	private static ExtendedInventorySaver extendedInventoriesSaver;
	
    public void onEnable() 
	{
    	besterArmorInitializationCrap();
        
        besterArmorTimedTasks();
    }
 
    public void onDisable() 
    {
    	saveInventories();
    }
    
    private void besterArmorInitializationCrap()
    {
    	thisPlugin = this;
        
        extendedInventoriesSaver = new ExtendedInventorySaver();
        
        armorManager = new ArmorManager(extendedInventoriesSaver);
        
        armorListener = new ArmorListener();
        horseListener = new HorseMountListener();
        decloakListener = new DecloakListener();        
        
        establishListeners();
    }
    
    private void establishListeners()
    {
    	getServer().getPluginManager().registerEvents(armorListener, thisPlugin);
    	getServer().getPluginManager().registerEvents(horseListener, thisPlugin);
    	getServer().getPluginManager().registerEvents(decloakListener, thisPlugin);
    }
    
    private void besterArmorTimedTasks()
    {
    	BukkitScheduler scheduler = Bukkit.getServer().getScheduler();
        scheduler.scheduleSyncRepeatingTask(this, new Runnable() {
            @Override
            public void run() 
            {
                armorManager.decrimentCoolDown();
            }
        }, 0L, 20L);
        
        scheduler.scheduleSyncRepeatingTask(this, new Runnable() {
            @Override
            public void run() 
            {                
                for(Player player : armorManager.getFireProtPlayers())
                {
                	armorManager.distributePotionEffects(player);
                }
            }
        }, 0L, 100L);
    }
    
    private void saveInventories()
    {
    	for(Player player : Bukkit.getServer().getOnlinePlayers())
    	{
    		if(ArmorManager.readArmor(player).getArmorType().equals(ArmorType.GOLD))
    		{
    			extendedInventoriesSaver.saveExtendedInventory(player);
    		}
    	}
    }
    
    public static ArmorManager getArmorManager()
    {
    	return armorManager;
    }
    
    public static ExtendedInventorySaver getExtendedInventorySaver()
    {
    	return extendedInventoriesSaver;
    }
    
    public static Plugin getPlugin()
    {
    	return thisPlugin;
    }
    
}
